From 810b9932096e49401c8ca32a0c1a69b8624bfb77 Mon Sep 17 00:00:00 2001
From: Hou Zhiqiang <Zhiqiang.Hou@nxp.com>
Date: Mon, 22 Aug 2022 16:58:03 +0800
Subject: [PATCH] imx8mmevk: str echo: increase rpmsg buffer to 8MB

Signed-off-by: Biwen Li <biwen.li@nxp.com>
Signed-off-by: Hou Zhiqiang <Zhiqiang.Hou@nxp.com>
---
 .../rpmsg_lite_str_echo_rtos/FreeRTOSConfig.h                 | 2 +-
 .../multicore_examples/rpmsg_lite_str_echo_rtos/main_remote.c | 2 +-
 .../rpmsg_lite_str_echo_rtos/rpmsg_config.h                   | 4 ++--
 .../multicore_examples/rpmsg_lite_str_echo_rtos/rsc_table.c   | 3 +--
 4 files changed, 5 insertions(+), 6 deletions(-)

diff --git a/evkmimx8mm/multicore_examples/rpmsg_lite_str_echo_rtos/FreeRTOSConfig.h b/evkmimx8mm/multicore_examples/rpmsg_lite_str_echo_rtos/FreeRTOSConfig.h
index 3679035587..3fa4597bee 100644
--- a/evkmimx8mm/multicore_examples/rpmsg_lite_str_echo_rtos/FreeRTOSConfig.h
+++ b/evkmimx8mm/multicore_examples/rpmsg_lite_str_echo_rtos/FreeRTOSConfig.h
@@ -128,7 +128,7 @@
 #define configUSE_MUTEXES                       1
 
 #ifndef configTOTAL_HEAP_SIZE
-#define configTOTAL_HEAP_SIZE ((size_t)(40 * 1024))
+#define configTOTAL_HEAP_SIZE ((size_t)(80 * 1024))
 #endif
 
 /* Interrupt nesting behaviour configuration. Cortex-M specific. */
diff --git a/evkmimx8mm/multicore_examples/rpmsg_lite_str_echo_rtos/main_remote.c b/evkmimx8mm/multicore_examples/rpmsg_lite_str_echo_rtos/main_remote.c
index c1210a7302..a182ba368a 100644
--- a/evkmimx8mm/multicore_examples/rpmsg_lite_str_echo_rtos/main_remote.c
+++ b/evkmimx8mm/multicore_examples/rpmsg_lite_str_echo_rtos/main_remote.c
@@ -33,7 +33,7 @@
 #endif
 
 /* Globals */
-static char app_buf[512]; /* Each RPMSG buffer can carry less than 512 payload */
+static char app_buf[1024]; /* Each RPMSG buffer can carry less than 1024 payload */
 
 /*******************************************************************************
  * Prototypes
diff --git a/evkmimx8mm/multicore_examples/rpmsg_lite_str_echo_rtos/rpmsg_config.h b/evkmimx8mm/multicore_examples/rpmsg_lite_str_echo_rtos/rpmsg_config.h
index ff0f400a8e..3e9b1fe978 100644
--- a/evkmimx8mm/multicore_examples/rpmsg_lite_str_echo_rtos/rpmsg_config.h
+++ b/evkmimx8mm/multicore_examples/rpmsg_lite_str_echo_rtos/rpmsg_config.h
@@ -31,7 +31,7 @@
 //! Size of the buffer payload, it must be equal to (240, 496, 1008, ...)
 //! [2^n - 16]. Ensure the same value is defined on both sides of rpmsg
 //! communication. The default value is 496U.
-#define RL_BUFFER_PAYLOAD_SIZE (496U)
+#define RL_BUFFER_PAYLOAD_SIZE (496U + 512U)
 
 //! @def RL_BUFFER_COUNT
 //!
@@ -41,7 +41,7 @@
 //! communication only, i.e. if the default value of 2 is used
 //! in rpmsg_config.h files for the master and the remote side, 4 buffers
 //! in total are created in the shared memory.
-#define RL_BUFFER_COUNT (256U)
+#define RL_BUFFER_COUNT (256U * 4 * 4)
 
 //! @def RL_API_HAS_ZEROCOPY
 //!
diff --git a/evkmimx8mm/multicore_examples/rpmsg_lite_str_echo_rtos/rsc_table.c b/evkmimx8mm/multicore_examples/rpmsg_lite_str_echo_rtos/rsc_table.c
index 5346e3dca7..3e27ee79d6 100644
--- a/evkmimx8mm/multicore_examples/rpmsg_lite_str_echo_rtos/rsc_table.c
+++ b/evkmimx8mm/multicore_examples/rpmsg_lite_str_echo_rtos/rsc_table.c
@@ -69,6 +69,5 @@ void copyResourceTable(void)
      * VDEV0_VRING_BASE is temperorily kept for backward compatibility, will be
      * removed in future release
      */
-    memcpy((void *)VDEV0_VRING_BASE, &resources, sizeof(resources));
-    memcpy((void *)(VDEV0_VRING_BASE + RESOURCE_TABLE_OFFSET), &resources, sizeof(resources));
+    memcpy((void *)(VDEV0_VRING_BASE + 2 * VRING_SIZE + 0x800000), &resources, sizeof(resources));
 }
-- 
2.17.1

